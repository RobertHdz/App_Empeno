<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Control - Auto Empe침o Luna</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="LOGOEMP.png" alt="Logo" class="sidebar-logo">
      <h2>Panel de <span>Control</span></h2>
    </div>
    
    <nav class="sidebar-nav">
      <ul>
        <li><a href="index.html" class="active">
          <span class="icon">&#127968;</span> Resumen 
        </a></li>
        <li><a href="nuev_emp.html">
          <span class="icon">&#10133;</span> Nuevo Empe침o
        </a></li>
        <li><a href="ref.html">
          <span class="icon">&#128260;</span> Refrendo
        </a></li>
        <li><a href="desemp.html">
          <span class="icon">&#9989;</span> Desempe침o
        </a></li>
        <li><a href="reevaluo.html">
          <span class="icon">&#128220;</span> Reval칰o
        </a></li>
        <li><a href="clientes.html">
          <span class="icon">&#128101;</span> Clientes
        </a></li>
        <li><a href="history.html">
          <span class="icon">&#128214;</span> Historial Empe침os
        </a></li>
        <li><a href="remate.html">
          <span class="icon">&#128739;</span> Remate Empe침os
        </a></li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <a href="index.html" class="logout-button">
        <span class="icon">&#128682;</span> Cerrar Sesi칩n
      </a>
    </div>
  </aside>

  <div class="main-content">
    
    <header class="main-header">
      <button id="menu-toggle" class="hamburger-button">&#9776;</button>
      <h1>Historial de ultimas acciones</h1>
      <div class="user-info">
        <span>Bienvenido</span>
      </div>
    </header>

    <main class="content">
      
      <section class="stats-cards">
        <div class="card">
          <h3>Total de Empe침os</h3>
          <p class="stat-number" id="stat-total">Cargando...</p>
        </div>
        <div class="card">
          <h3>Total de Empe침os Activos</h3>
          <p class="stat-number" id="stat-activos">Cargando...</p>
        </div>
        <div class="card">
          <h3>Articulos desempe침ados </h3>
          <p class="stat-number" id="stat-desempenados">Cargando...</p>
        </div>
        <div class="card">
          <h3>Art칤culos en Remate</h3>
          <p class="stat-number" id="stat-perdidos">Cargando...</p>
        </div>
      </section>

      <section class="content-placeholder">
        <h2>Acciones R치pidas</h2>
        <p>Clientes recientes.</p>
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Acci칩n</th>
              <th>Art칤culo</th>
              <th>Monto</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="tabla-acciones-body">
            </tbody>
        </table>
      </section>

    </main>
  </div>

  <div class="overlay" id="overlay"></div>

  <script>
    // L칩gica para CERRAR SESI칍N
    const btnLogout = document.querySelector('.logout-button');

    if (btnLogout) {
        btnLogout.addEventListener('click', (e) => {
            e.preventDefault(); // Evita que el enlace navegue solo
            
            // 1. Borramos la llave del navegador
            localStorage.removeItem('token_auto_empeno');
            
            // 2. (Opcional) Avisamos al usuario
            alert('Sesi칩n cerrada correctamente');

            // 3. Redirigimos al Login
            window.location.href = '/';
        });
    }

    // L칩gica de PROTECCI칍N (Si no tienes llave, 춰fuera de aqu칤!)
    const token = localStorage.getItem('token_auto_empeno');
    if (!token) {
        window.location.href = '/';
    }
    // Funci칩n para dar formato de dinero ($1,500.00)
    const formatoMoneda = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });

    async function cargarDashboard() {
        try {
            // ... dentro de cargarDashboard ...

            // 2. Cargar Tabla de Acciones R치pidas esta ya funciona no le muevas nada
            const resTabla = await fetch('/dashboard/tabla', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (resTabla.ok) {
                const filas = await resTabla.json();
                const tbody = document.getElementById('tabla-acciones-body');
                tbody.innerHTML = ''; 

                // Log para depuraci칩n: ver qu칠 trae el backend
                  console.debug('Dashboard - filas recibidas:', filas);

                // Limpiar tbody de forma segura
                while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

                if (!filas || filas.length === 0) {
                  const trEmpty = document.createElement('tr');
                  const tdEmpty = document.createElement('td');
                  tdEmpty.colSpan = 5;
                  tdEmpty.style.textAlign = 'center';
                  tdEmpty.textContent = 'Sin movimientos recientes';
                  trEmpty.appendChild(tdEmpty);
                  tbody.appendChild(trEmpty);
                } else {
                  filas.forEach(fila => {
                  const tr = document.createElement('tr');

                    // 1. Normalizaci칩n ROBUSTA:
                    // a) Pasar a min칰sculas. b) Eliminar diacr칤ticos (acentos). c) Quitar espacios.
                    const accionNorm = (fila.accion || '').toString()
                        .toLowerCase()
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                        .replace(/\s/g, ''); // Quita espacios

                    // 游꿢 L칍GICA DE ASIGNACI칍N (Asegurando la coincidencia con las clases CSS):
                    let badgeClass = 'status-nuevo-empeno'; // Por defecto (Nuevo Empe침o)

                    // Mapear las acciones esperadas a clases (buscamos fragmentos comunes)
                    if (accionNorm.includes('ventaremate') || accionNorm.includes('venta')) {
                      badgeClass = 'status-venta-remate';
                    } else if (accionNorm.includes('desempeno') || accionNorm.includes('desempenad') || accionNorm.includes('desemp')) {
                      badgeClass = 'status-desempeno-accion';
                    } else if (accionNorm.includes('refrendo')) {
                      badgeClass = 'status-refrendo-accion';
                    } else if (accionNorm.includes('reevaluo')) {
                      badgeClass = 'status-reevaluo-accion';
                    } else if (accionNorm.includes('nuevo') || accionNorm.includes('empeno')) {
                      badgeClass = 'status-nuevo-empeno';
                    }
                    // FIN DE LA L칍GICA

                    // Formato de moneda (se omite para brevedad)
                    const montoVal = Number(fila.monto) || 0;
                    const signo = montoVal < 0 ? '-' : '+';
                    const montoFmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(Math.abs(montoVal));

                    // Construir celdas de forma segura
                    const tdCliente = document.createElement('td');
                    const spanCliente = document.createElement('span');
                    spanCliente.style.fontWeight = 'bold'; spanCliente.style.color = '#555';
                    spanCliente.textContent = fila.cliente || '';
                    tdCliente.appendChild(spanCliente);

                    const tdAccion = document.createElement('td');
                    const spanAcc = document.createElement('span');
                    
                    // 游눤 L칈NEA CR칈TICA: La clase 'status' DEBE estar aqu칤 para el relleno.
                    spanAcc.className = 'status ' + badgeClass; 
                    
                    spanAcc.textContent = fila.accion || '';
                    tdAccion.appendChild(spanAcc);

                    const tdArticulo = document.createElement('td'); tdArticulo.textContent = fila.articulo || '';
                    const tdMonto = document.createElement('td'); tdMonto.style.fontWeight = 'bold'; tdMonto.textContent = `${signo} ${montoFmt}`;
                    const tdFecha = document.createElement('td'); tdFecha.textContent = fila.fecha || '';

                    tr.appendChild(tdCliente);
                    tr.appendChild(tdAccion);
                    tr.appendChild(tdArticulo);
                    tr.appendChild(tdMonto);
                    tr.appendChild(tdFecha);

                    tbody.appendChild(tr);
                });}
            } else {
                console.error('Error al cargar tabla de acciones r치pidas');
            }
  
            // 1. Cargar estad칤sticas del dashboard
            // Pedimos TODOS los empe침os existentes
            // (Usamos el endpoint b치sico que ya existe, no el de KPIs)
            const resTodos = await fetch('/empenos/todos', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (resTodos.ok) {
                const todos = await resTodos.json();
                
                // --- A. C츼LCULOS ---

                // Total de Empe침os
                document.getElementById('stat-total').innerText = todos.length;

                // 1. Empe침os Activos (Vigentes + Vencidos)
                const activos = todos.filter(e => e.estado === 'Vigente' || e.estado === 'Vencido');
                const cantidadActivos = activos.length;
                document.getElementById('stat-activos').innerText = cantidadActivos;
                // 2. Art칤culos Desempe침ados
                const desempenados = todos.filter(item => item.estado === 'Desempe침ado').length;
                document.getElementById('stat-desempenados').innerText = desempenados;

                // 4. En remate
                const perdidos = todos.filter(item => 
                    item.estado === 'Rematado' || item.estado === 'Vendido'
                ).length;
                document.getElementById('stat-perdidos').innerText = perdidos;
            }

        } catch (error) {
            console.error('Error cargando dashboard:', error);
        }
    }
    // Ejecutar cuando cargue la p치gina
    document.addEventListener('DOMContentLoaded', cargarDashboard);
  </script>
</body>
</html>