<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acceso - Auto Empe√±o Luna</title>
  <link rel="stylesheet" href="login.css">
  <style>
    /* Estilos extra para la transici√≥n entre formularios */
    .hidden {
      display: none;
    }
    
    .switch-link {
      margin-top: 15px;
      text-align: center;
      font-size: 0.9em;
      color: #555;
    }
    
    .switch-link a {
      color: #113b64;
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
    }
    
    .switch-link a:hover {
      text-decoration: underline;
    }

    /* Estilo para el campo de contrase√±a maestra (importante) */
    .master-pass-group input {
      border: 2px solid #f5b301; /* Borde amarillo para resaltar seguridad */
    }
  </style>
</head>
<body>

  <div class="split-container">

    <div class="brand-side">
      <h1>AUTO EMPE√ëO <span>LUNA</span></h1>
      <div class="brand-logo">
        <img src="LOGOEMP.png" alt="Logo Auto Empe√±os Luna">
      </div>
      <p>Bienvenido al Panel de Control</p>
      <p class="slogan">
        ¬°NO SOMOS UNA OPCI√ìN,<br>
        <span>SOMOS TU SOLUCI√ìN!</span>
      </p>
    </div>

    <div class="form-side">
      
      <form id="login-form" class="login-form">
        <h2>Iniciar Sesi√≥n</h2>
        
        <div class="input-group">
          <label for="usuario">Usuario</label>
          <input type="text" id="usuario" name="usuario" required placeholder="Ej: admin">
        </div>
  
        <div class="input-group">
          <label for="contrasena">Contrase√±a</label>
          <input type="password" id="contrasena" name="contrasena" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
  
        <button type="submit" class="login-btn">Ingresar</button>
        
        <p id="error-message" class="error-msg" style="display: none;"></p>

        <div class="switch-link">
          ¬øNuevo cliente? <a onclick="mostrarRegistro()">Registrar aqu√≠</a>
        </div>
      </form>


      <form id="register-form" class="login-form hidden">
        <h2>Registrar Empleado</h2>
        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
            Crea un usuario nuevo para el sistema.
        </p>

        <div class="input-group">
            <label>Nombre Completo</label>
            <input type="text" id="reg-nombre" required placeholder="Ej: Juan P√©rez">
        </div>

        <div class="input-group">
            <label>Nuevo Usuario</label>
            <input type="text" id="reg-usuario" required placeholder="Ej: juanp">
        </div>

        <div class="input-group">
            <label>Nueva Contrase√±a</label>
            <input type="password" id="reg-pass" required placeholder="Crear contrase√±a">
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

        <div class="input-group master-pass-group">
            <label style="color: #d9534f; font-weight:bold;">üîê Contrase√±a de Admin</label>
            <input type="password" id="reg-admin-pass" required placeholder="Tu contrase√±a actual para confirmar">
            <small style="font-size: 0.7em; color: #888;">Necesaria para autorizar el registro.</small>
        </div>

        <button type="submit" class="login-btn" >Crear Usuario</button>
        
        <p id="reg-error-message" class="error-msg" style="display: none;"></p>

        <div class="switch-link">
          <a onclick="mostrarLogin()">‚Üê Volver al Login</a>
        </div>
      </form>

    </div>
  </div>

  <script>
    // --- L√ìGICA DE INTERFAZ (SWAP) ---
    function mostrarRegistro() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('reg-error-message').style.display = 'none';
    }

    function mostrarLogin() {
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('error-message').style.display = 'none';
    }

    // --- 1. L√ìGICA DE LOGIN (La que ya ten√≠as) ---
    const loginForm = document.getElementById('login-form');
    const errorMessage = document.getElementById('error-message');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const usuario = document.getElementById('usuario').value;
      const contrasena = document.getElementById('contrasena').value;

      const datosParaEnviar = new URLSearchParams();
      datosParaEnviar.append('username', usuario);
      datosParaEnviar.append('password', contrasena);

      try {
        const response = await fetch('/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: datosParaEnviar
        });

        if (response.ok) {
          const result = await response.json();
          localStorage.setItem('token_auto_empeno', result.access_token);
          window.location.href = 'dash.html';
        } else {
          errorMessage.innerText = 'Usuario o contrase√±a incorrectos.';
          errorMessage.style.display = 'block';
        }
      } catch (error) {
        errorMessage.innerText = 'Error de conexi√≥n con el servidor.';
        errorMessage.style.display = 'block';
      }
    });

    // --- 2. L√ìGICA DE REGISTRO (NUEVO) ---
    const registerForm = document.getElementById('register-form');
    const regErrorMessage = document.getElementById('reg-error-message');

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Recogemos datos
        const nombre = document.getElementById('reg-nombre').value;
        const usuario = document.getElementById('reg-usuario').value;
        const password = document.getElementById('reg-pass').value;
        const adminAuth = document.getElementById('reg-admin-pass').value;

        // Validar que no est√©n vac√≠os
        if(!nombre || !usuario || !password || !adminAuth) {
            regErrorMessage.innerText = "Todos los campos son obligatorios";
            regErrorMessage.style.display = "block";
            return;
        }

        const payload = {
            nuevo_usuario: {
                usuario: usuario,
                password: password,
                nombre_completo: nombre,
                rol: "empleado" // Por defecto creamos empleados
            },
            admin_password: adminAuth // Enviamos la contrase√±a del jefe para validar
        };

        try {
            // Nota: Este endpoint lo crearemos en el siguiente paso en Python
            const res = await fetch('/registrar-empleado-seguro', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("‚úÖ ¬°Usuario registrado exitosamente!\nAhora puedes iniciar sesi√≥n.");
                mostrarLogin();
                // Limpiar campos
                registerForm.reset();
            } else {
                const err = await res.json();
                regErrorMessage.innerText = err.detail || "Error al registrar";
                regErrorMessage.style.display = "block";
            }
        } catch (error) {
            regErrorMessage.innerText = "Error de conexi√≥n";
            regErrorMessage.style.display = "block";
        }
    });
  </script>
</body>
</html>